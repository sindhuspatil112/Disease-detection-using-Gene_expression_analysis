{% extends "base.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  .risk-card { transition: transform 0.2s; }
  .risk-card:hover { transform: translateY(-5px); }
  .gene-item { padding: 8px; margin: 4px 0; background: #f8f9fa; border-radius: 6px; }
  .biomarker-section { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
</style>
<div class="container mt-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ğŸ“Š Cancer Risk Analysis Results</h2>
    <span class="badge bg-{{ 'primary' if user_role == 'user' else 'success' if user_role == 'doctor' else 'info' }} fs-6">
      {{ user_role|title }} View
    </span>
  </div>

  <!-- RISK CARDS -->
  <div class="row g-4 mb-4">
    {% for disease, value in results.items() %}
    {% set risk = "low" %}
    {% if value >= 70 %}{% set risk = "high" %}{% elif value >= 40 %}{% set risk = "medium" %}{% endif %}
    
    <div class="col-md-4">
      <div class="card risk-card h-100 text-center border-0 shadow-sm">
        <div class="card-body">
          <div class="display-4 mb-3">
            {% if disease == 'breast' %}ğŸ€
            {% elif disease == 'lung' %}ğŸ«‘
            {% elif disease == 'ovarian' %}ğŸ©º
            {% endif %}
          </div>
          <h5 class="card-title text-capitalize">{{ disease }} Cancer</h5>
          <h2 class="display-4 fw-bold text-{{ 'danger' if risk=='high' else 'warning' if risk=='medium' else 'success' }}">{{ value }}%</h2>
          <span class="badge bg-{{ 'danger' if risk=='high' else 'warning' if risk=='medium' else 'success' }} fs-6 px-3 py-2">
            {{ risk|capitalize }} Risk
          </span>
          {% if user_role == 'doctor' %}
          <div class="mt-3">
            <button class="btn btn-sm btn-outline-primary">Add Clinical Note</button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- CHARTS -->
  <div class="row g-4 mb-4">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0">ğŸ“ˆ Risk Probability Comparison</h5>
        </div>
        <div class="card-body">
          <canvas id="riskChart" style="height:300px;"></canvas>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white">
          <h6 class="mb-0">ğŸ“Š Quick Stats</h6>
        </div>
        <div class="card-body">
          {% set max_risk = results.values() | max %}
          {% set avg_risk = (results.values() | sum / results.values() | length) | round(1) %}
          
          <div class="text-center mb-3">
            <h4 class="text-primary">{{ max_risk }}%</h4>
            <small class="text-muted">Highest Risk</small>
          </div>
          
          <div class="text-center mb-3">
            <h4 class="text-info">{{ avg_risk }}%</h4>
            <small class="text-muted">Average Risk</small>
          </div>
          
          {% if user_role == 'researcher' %}
          <div class="d-grid gap-2 mt-3">
            <button class="btn btn-sm btn-outline-success">ğŸ“Š Export Data</button>
            <button class="btn btn-sm btn-outline-info">ğŸ” Analyze Further</button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- BIOMARKER SECTION -->
  <div class="card border-0 shadow-sm mb-4 biomarker-section">
    <div class="card-header bg-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ§¬ Biomarker Analysis</h5>
        <button class="btn btn-primary" id="toggleBio">
          <span id="toggleText">Show Biomarkers</span> <i id="toggleIcon" class="bi bi-chevron-down"></i>
        </button>
      </div>
    </div>
    
    <div id="biomarkerContent" class="card-body" style="display:none;">
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <button class="btn btn-outline-danger btn-switch w-100" data-target="breast">
            ğŸ€ Breast Cancer
          </button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-primary btn-switch w-100" data-target="lung">
            ğŸ«‘ Lung Cancer
          </button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-warning btn-switch w-100" data-target="ovarian">
            ğŸ©º Ovarian Cancer
          </button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-success btn-switch w-100" data-target="common">
            ğŸ”— Common Genes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- GENES DISPLAY -->
  <div class="card border-0 shadow-sm" id="geneDisplayCard" style="display:none;">
    <div class="card-header bg-white">
      <h5 id="geneTitle" class="mb-0"></h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-lg-8">
          <div id="geneList" class="row g-2"></div>
        </div>
        <div class="col-lg-4">
          <div id="donutWrapper" class="text-center">
            <h6>Gene Count</h6>
            <canvas id="donutChart" style="max-width:200px;margin:auto;"></canvas>
            <div class="mt-3">
              <span class="badge bg-info fs-6" id="geneCount">0 genes</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- ROLE-BASED INTERPRETATION -->
    {% if user_role == 'user' %}
    <div class="card p-3 mt-4">
        <h5>ğŸ©º What This Means for You</h5>
        <div class="alert alert-info">
            <p><strong>Understanding Your Results:</strong></p>
            <ul>
                <li>These predictions are based on your gene expression patterns</li>
                <li>Higher percentages indicate increased risk factors</li>
                <li>Please discuss these results with your healthcare provider</li>
                <li>This is a screening tool, not a definitive diagnosis</li>
            </ul>
        </div>
    </div>
    {% elif user_role == 'doctor' %}
    <div class="card p-3 mt-4">
        <h5>ğŸ‘¨â€âš•ï¸ Clinical Interpretation</h5>
        <div class="alert alert-warning">
            <p><strong>Medical Professional Notes:</strong></p>
            <ul>
                <li>Risk scores based on validated ML models with 88-94% accuracy</li>
                <li>Consider patient history and additional diagnostic tests</li>
                <li>High-risk patients may benefit from enhanced screening protocols</li>
                <li>Biomarker analysis available for treatment planning</li>
            </ul>
            <button class="btn btn-primary mt-2" onclick="window.print()">ğŸ“„ Print Report</button>
        </div>
    </div>
    {% elif user_role == 'researcher' %}
    <div class="card p-3 mt-4">
        <h5>ğŸ”¬ Research Analysis</h5>
        <div class="alert alert-success">
            <p><strong>Research Insights:</strong></p>
            <ul>
                <li>Model performance metrics available in research dashboard</li>
                <li>Cross-cancer gene analysis shows {{ commonGenes|length if commonGenes else 0 }} common biomarkers</li>
                <li>Statistical significance: p < 0.001 for all models</li>
                <li>Data suitable for publication and further research</li>
            </ul>
            <button class="btn btn-success mt-2">ğŸ“Š Export Research Data</button>
        </div>
    </div>
    {% endif %}
    
  <div class="d-flex justify-content-between align-items-center mt-4 pt-4 border-top">
    <div>
      <small class="text-muted">Analysis completed successfully</small>
    </div>
    <div class="d-flex gap-2">
      <a href="/upload" class="btn btn-outline-primary">ğŸ”„ New Analysis</a>
      <a href="/history" class="btn btn-outline-secondary">ğŸ“‹ View History</a>
      <a href="/dashboard" class="btn btn-primary">â† Dashboard</a>
    </div>
  </div>
</div>

<script>
    const results = {{ results | tojson }};
    const shared = {{ shared_genes | tojson }};

    // Compute common genes
    // Compute common genes (top 10 only)
    const commonGenes = shared.breast
        .filter(g => shared.lung.includes(g) && shared.ovarian.includes(g))
        .slice(0, 10);

    // ========== CHARTS ==========
    const riskCtx = document.getElementById('riskChart');
    new Chart(riskCtx, {
      type:'bar',
      data:{labels:Object.keys(results),datasets:[{data:Object.values(results),borderRadius:6}]},
      options:{scales:{y:{beginAtZero:true,max:100}}}
    });

    let donutChart;
    function updateDonut(counts){
      if(donutChart){ donutChart.destroy(); }
      const ctx = document.getElementById('donutChart');
      donutChart = new Chart(ctx, {
        type:'doughnut',
        data:{labels:['Genes'],datasets:[{data:[counts]}]},
        options:{plugins:{legend:{display:false}}}
      });
    }

    updateDonut(0);

    // ========== BIOMARKER SELECTION ==========
    const geneTitle = document.getElementById('geneTitle');
    const geneList = document.getElementById('geneList');

    // Toggle Biomarker Section
    const toggleBio = document.getElementById('toggleBio');
    const biomarkerContent = document.getElementById('biomarkerContent');
    const toggleText = document.getElementById('toggleText');
    const geneDisplayCard = document.getElementById('geneDisplayCard');

    toggleBio.addEventListener('click', () => {
      const isShown = biomarkerContent.style.display === 'block';
      biomarkerContent.style.display = isShown ? 'none' : 'block';
      toggleText.textContent = isShown ? 'Show Biomarkers' : 'Hide Biomarkers';
    });

    document.querySelectorAll('.btn-switch').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.target;
        let genes = [];

        if(target === 'breast'){
          geneTitle.textContent = 'Breast Biomarkers';
          genes = shared.breast.slice(0,10);
        }
        else if(target === 'lung'){
          geneTitle.textContent = 'Lung Biomarkers';
          genes = shared.lung.slice(0,10);
        }
        else if(target === 'ovarian'){
          geneTitle.textContent = 'Ovarian Biomarkers';
          genes = shared.ovarian.slice(0,10);
        }
        else if(target === 'common'){
          geneTitle.textContent = 'Common Genes Across All Three';
          genes = commonGenes;
        }

        geneList.innerHTML = genes.length ? 
          genes.map(g=>`<div class="col-md-6"><div class="gene-item">${g}</div></div>`).join('') : 
          '<div class="col-12"><div class="alert alert-info">No genes found for this selection.</div></div>';
        
        geneDisplayCard.style.display = 'block';
        document.getElementById('geneCount').textContent = `${genes.length} genes`;
        updateDonut(genes.length);
      })
    })
  </script>

{% endblock %}
